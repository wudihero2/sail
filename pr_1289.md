# PR #1289 åˆ†æï¼šDataFrame Subquery Expressions via WithRelations
https://github.com/lakehq/sail/pull/1289/changes#diff-9f8c14d0955dc9433ca956720032ed88f455f89da4e082aafb8a79fd20df7d5a
```
from pyspark.sql import SparkSession

spark = SparkSession.builder.remote("sc://localhost:50051").getOrCreate()

# ä¸»è¡¨
df1 = spark.createDataFrame([(1, "Alice"), (2, "Bob"), (3, "Charlie"), (4, "David")], ["id", "name"])

# å­æŸ¥è©¢è¡¨ï¼ˆç”¨ä¾†éæ¿¾çš„ ID åˆ—è¡¨ï¼‰
df2 = spark.createDataFrame([(1,), (3,)], ["id"])

df1.filter(df1.id.isin(df2.select("id"))).show()

spark.stop()
```
## ğŸ”¸ PR æ¦‚è¿°

é€™å€‹ PR å¯¦ç¾äº† DataFrame subquery expressionsï¼Œæ”¯æŒä¸‰ç¨®é¡å‹ï¼š

| é¡å‹ | PySpark ç”¨æ³• | SQL ç­‰åƒ¹ |
|-----|-------------|---------|
| IN | `df.filter(col("id").isin(other_df))` | `WHERE id IN (SELECT ...)` |
| Scalar | `df.select(scalar_subquery(...))` | `SELECT (SELECT max(x) FROM t)` |
| EXISTS | `df.filter(exists(other_df))` | `WHERE EXISTS (SELECT ...)` |

---

## ğŸ”¸ ç‚ºä»€éº¼ Spark Connect é€™æ¨£è¨­è¨ˆå”è­°ï¼Ÿ

### DataFrame API çš„ç‰¹æ€§

SQL ä¸­ï¼Œsubquery æ˜¯å…§åµŒçš„ï¼š

```sql
SELECT * FROM users WHERE id IN (SELECT user_id FROM orders)
```

ä½† DataFrame API ä¸åŒï¼ŒDataFrame æ˜¯ã€Œç¨ç«‹ç‰©ä»¶ã€ï¼š

```python
users_df = spark.table("users")
orders_df = spark.table("orders")

# orders_df æ˜¯ç¨ç«‹çš„ DataFrameï¼Œä¸æ˜¯ users_df çš„ä¸€éƒ¨åˆ†
result = users_df.filter(col("id").isin(orders_df.select("user_id")))
```

### åºåˆ—åŒ–çš„æŒ‘æˆ°

å¦‚æœç”¨ã€Œå…§åµŒã€æ–¹å¼åºåˆ—åŒ–ï¼Œæ¯æ¬¡å¼•ç”¨ `orders_df` éƒ½è¦å®Œæ•´è¤‡è£½ä¸€ä»½ planï¼š
- é‡è¤‡åºåˆ—åŒ–ï¼ˆæµªè²»é »å¯¬ï¼‰
- é‡è¤‡è§£æï¼ˆæµªè²» CPUï¼‰
- ç„¡æ³•è­˜åˆ¥ã€Œé€™æ˜¯åŒä¸€å€‹ DataFrameã€ï¼ˆç„¡æ³•å…±äº«è¨ˆç®—ï¼‰

### Spark Connect çš„è§£æ³•ï¼šWithRelations

```
WithRelations {
    root: ä¸»æŸ¥è©¢ï¼ˆç”¨ plan_id å¼•ç”¨ subqueryï¼‰
    references: [
        { plan_id: 1, plan: subquery å®šç¾© }
    ]
}
```

å„ªé»ï¼šæ¯å€‹ subquery åªåºåˆ—åŒ–ä¸€æ¬¡ï¼Œå¤šè™•å¯å¼•ç”¨åŒä¸€å€‹ plan_idã€‚

---

## ğŸ”¸ Sail çš„ä¸‰å±¤æ¶æ§‹

```
Proto Layer â”€â”€â–º Spec Layer â”€â”€â–º DataFusion Layer
(Spark å®šç¾©)    (Sail å®šç¾©)    (DataFusion å®šç¾©)
```

### ç‚ºä»€éº¼éœ€è¦ Spec Layerï¼Ÿ

Proto å’Œ DataFusion çš„é¡å‹ä¸å°æ‡‰ï¼š

| Proto | DataFusion |
|-------|-----------|
| `SubqueryExpression { plan_id: i64 }` | `InSubquery { subquery: Arc<LogicalPlan> }` |

Proto åªæœ‰ `plan_id`ï¼Œä½† DataFusion éœ€è¦å®Œæ•´çš„ `LogicalPlan`ã€‚

Spec Layer è®“æˆ‘å€‘å¯ä»¥ï¼š
1. å…ˆæŠŠ Proto è½‰æˆ Specï¼ˆä¿ç•™ plan_idï¼‰
2. åœ¨ Resolver éšæ®µè™•ç†å¼•ç”¨é—œä¿‚

---

## ğŸ”¸ æ ¸å¿ƒå•é¡Œï¼šè§£æé †åº

æ”¶åˆ°çš„ protobuf çµæ§‹ï¼š

```
WithRelations {
    root: Filter {
        condition: SubqueryExpression { plan_id: 1 }  â—„â”€â”€ å¼•ç”¨ plan_id=1
    }
    references: [
        { plan_id: 1, node: Project { ... } }  â—„â”€â”€ plan_id=1 çš„å®šç¾©
    ]
}
```

å•é¡Œï¼šè§£æ `root` æ™‚é‡åˆ° `SubqueryExpression(plan_id=1)`ï¼Œä½† DataFusion çš„ API éœ€è¦å®Œæ•´çš„ `LogicalPlan`ï¼Œä¸èƒ½å‚³ `plan_id`ã€‚

è€Œä¸” `references` é‚„æ²’è§£æï¼Œæˆ‘å€‘æ²’æœ‰ plan_id=1 å°æ‡‰çš„ `LogicalPlan`ã€‚

---

## ğŸ”¸ è§£æ³•ï¼šä¸‰æ­¥é©Ÿè§£æ + Placeholder

```
Step 1: å…ˆè§£æ references
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ HashMap { 1 => LogicalPlan(...) }â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 2: è§£æ rootï¼ˆé‡åˆ° SubqueryExpression æ™‚å‰µå»º placeholderï¼‰
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Filter {                         â”‚
        â”‚   condition: InSubquery {        â”‚
        â”‚     subquery: Placeholder(id=1)  â”‚  â—„â”€â”€ å‡çš„ LogicalPlan
        â”‚   }                              â”‚
        â”‚ }                                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Step 3: æ›¿æ› placeholder
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Filter {                         â”‚
        â”‚   condition: InSubquery {        â”‚
        â”‚     subquery: çœŸæ­£çš„ LogicalPlan â”‚  â—„â”€â”€ å¾ HashMap å–å‡º
        â”‚   }                              â”‚
        â”‚ }                                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç‚ºä»€éº¼éœ€è¦ Placeholderï¼Ÿ

DataFusion çš„ `InSubquery` æ§‹é€ å‡½æ•¸ï¼š

```rust
pub fn in_subquery(expr: Expr, subquery: Arc<LogicalPlan>) -> Expr
```

å¿…é ˆå‚³å…¥ `LogicalPlan`ï¼Œä¸èƒ½å‚³ null æˆ– Optionã€‚

æ‰€ä»¥æˆ‘å€‘å‰µå»ºä¸€å€‹ã€Œå‡çš„ã€`LogicalPlan`ï¼ˆUnresolvedSubqueryRefï¼‰ï¼Œå®ƒï¼š
- å¸¶æœ‰ plan_id è³‡è¨Š
- æœ‰ä¸€å€‹ dummy schemaï¼ˆDataFusion API è¦æ±‚ï¼‰
- æœ€çµ‚æœƒè¢«æ›¿æ›æ‰

### ç‚ºä»€éº¼ Placeholder æ•…æ„ä¸èƒ½åŸ·è¡Œï¼Ÿ

å¦‚æœæœ‰ bug å°è‡´ placeholder æ²’è¢«æ›¿æ›ï¼š
- DataFusion å˜—è©¦ physical planning
- æ‰¾ä¸åˆ°å°æ‡‰çš„ ExtensionPlanner
- ç›´æ¥å ±éŒ¯

é€™æ¯”ã€Œéœé»˜ç”¢ç”ŸéŒ¯èª¤çµæœã€å¥½å¾—å¤šã€‚é€™æ˜¯é˜²ç¦¦æ€§è¨­è¨ˆã€‚

---

## ğŸ”¸ ç‚ºä»€éº¼ç”¨ transform_upï¼Ÿ

æ›¿æ› placeholder æ™‚ï¼Œç”¨ã€Œç”±ä¸‹è€Œä¸Šã€éæ­·ï¼š

```
Plan Tree:
    Filter                    â—„â”€â”€ å¾Œè™•ç†
    â””â”€â”€ condition: InSubquery
        â””â”€â”€ subquery: Placeholder  â—„â”€â”€ å…ˆè™•ç†
```

åŸå› ï¼š
- æ›¿æ› placeholder å¾Œï¼Œschema æœƒæ”¹è®Š
- ä¸Šå±¤ç¯€é»çš„ schema ä¾è³´ä¸‹å±¤
- å¿…é ˆå…ˆè™•ç†ä¸‹å±¤ï¼Œä¸Šå±¤æ‰èƒ½æ­£ç¢ºè¨ˆç®— schema

---

## ğŸ”¸ ç‚ºä»€éº¼ Projection éœ€è¦ç‰¹æ®Šè™•ç†ï¼Ÿ

æ›¿æ› placeholder å¾Œï¼Œéœ€è¦é‡å»ºç¯€é»ã€‚ä½† Projection æ¯”è¼ƒç‰¹æ®Šï¼š

- Projection çš„ schema æ˜¯å¾ expressions æ¨å°çš„
- æ›¿æ›å¾Œ expression çš„é¡å‹æ”¹è®Šï¼ˆå¾ Null è®Šæˆå¯¦éš›é¡å‹ï¼‰
- å¿…é ˆç”¨ `Projection::try_new()` é‡æ–°è¨ˆç®— schema

å…¶ä»–ç¯€é»å¯ä»¥ç”¨é€šç”¨çš„ `with_new_exprs()`ã€‚

---

## ğŸ”¸ å®Œæ•´è³‡æ–™æµ

```
PySpark: df.filter(col("id").isin(other_df))
                    â”‚
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Protobuf                                                   â”‚
â”‚  WithRelations {                                            â”‚
â”‚      root: Filter { SubqueryExpression(plan_id=1) }        â”‚
â”‚      references: [{ plan_id=1, Project(...) }]             â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ Proto â†’ Spec
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Spec Layer                                                 â”‚
â”‚  QueryNode::WithRelations {                                 â”‚
â”‚      root: Filter { SubqueryExpressionRef(plan_id=1) }     â”‚
â”‚      references: [QueryPlan { plan_id=1, Project }]        â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ Resolver (ä¸‰æ­¥é©Ÿ)
                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DataFusion LogicalPlan                                     â”‚
â”‚  Filter {                                                   â”‚
â”‚      predicate: InSubquery {                                â”‚
â”‚          subquery: Projection(...)  â—„â”€â”€ å®Œæ•´çš„ LogicalPlan â”‚
â”‚      }                                                      â”‚
â”‚  }                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
              DataFusion åŸ·è¡Œ
```

---

## ğŸ”¸ æ¶‰åŠçš„æª”æ¡ˆ

| æª”æ¡ˆ | è§’è‰² |
|-----|------|
| `spec/plan.rs` | å®šç¾© `QueryNode::WithRelations` |
| `spec/expression.rs` | å®šç¾© `Expr::SubqueryExpressionRef`, `SubqueryType` |
| `proto/plan.rs` | Proto â†’ Spec è½‰æ›ï¼ˆWithRelationsï¼‰ |
| `proto/expression.rs` | Proto â†’ Spec è½‰æ›ï¼ˆSubqueryExpressionï¼‰ |
| `unresolved_subquery_ref.rs` | Placeholder ç¯€é»å¯¦ç¾ |
| `resolver/expression/subquery.rs` | å‰µå»ºå¸¶ placeholder çš„ expression |
| `resolver/query/with_relations.rs` | ä¸‰æ­¥é©Ÿè§£æé‚è¼¯ |

---

## ğŸ”¸ æœªä¾†å¯¦ç¾é¡ä¼¼åŠŸèƒ½çš„æŒ‡å—

ç•¶é‡åˆ°ã€Œå¼•ç”¨ã€å•é¡Œï¼ˆA å¼•ç”¨ Bï¼Œä½† B é‚„æ²’è§£æï¼‰æ™‚ï¼š

### è§£æ³• 1ï¼šæ”¹è®Šè§£æé †åº

å…ˆè§£æè¢«å¼•ç”¨çš„éƒ¨åˆ†ï¼Œå­˜å…¥ HashMapï¼Œå†è§£æå¼•ç”¨æ–¹ã€‚

é©ç”¨ï¼šè¢«å¼•ç”¨çš„éƒ¨åˆ†å¯ä»¥ç¨ç«‹è§£æã€‚

### è§£æ³• 2ï¼šPlaceholder + å¾ŒçºŒæ›¿æ›

å‰µå»ºå‡çš„ç¯€é»ï¼Œè§£æå®Œæˆå¾Œå†æ›¿æ›ã€‚

é©ç”¨ï¼šç„¡æ³•æ”¹è®Šè§£æé †åºï¼Œæˆ–æœ‰å¾ªç’°å¼•ç”¨ã€‚

### è§£æ³• 3ï¼šå»¶é²è§£æ

ä¿ç•™å¼•ç”¨è³‡è¨Šï¼Œç­‰çœŸæ­£éœ€è¦æ™‚å†è§£æã€‚

é©ç”¨ï¼šä¸ä¸€å®šæœƒç”¨åˆ°çš„æƒ…æ³ã€‚

é€™å€‹ PR ç”¨äº†è§£æ³• 1 + è§£æ³• 2ï¼š
- å…ˆè§£æ referencesï¼ˆè§£æ³• 1ï¼‰
- è§£æ root æ™‚å‰µå»º placeholderï¼ˆè§£æ³• 2ï¼‰
- æœ€å¾Œæ›¿æ›ï¼ˆè§£æ³• 2ï¼‰

### å¯¦ç¾æ­¥é©Ÿ

```
1. ç†è§£ Proto çµæ§‹
   â””â”€â”€ æ‰¾åˆ°å°æ‡‰çš„ protobuf å®šç¾©

2. è¨­è¨ˆ Spec é¡å‹
   â””â”€â”€ å®šç¾©å¯ä»¥ã€Œå»¶é²è™•ç†ã€çš„ä¸­é–“è¡¨ç¤º

3. å¯¦ç¾ Proto â†’ Spec è½‰æ›
   â””â”€â”€ ä¿ç•™å¼•ç”¨è³‡è¨Šï¼ˆå¦‚ plan_idï¼‰

4. å¯¦ç¾ Resolver
   â””â”€â”€ è™•ç†å¼•ç”¨é—œä¿‚å’Œè§£æé †åº

5. å¦‚æœéœ€è¦ Placeholder
   â””â”€â”€ å¯¦ç¾ Extension ç¯€é»
   â””â”€â”€ å¯¦ç¾æ›¿æ›é‚è¼¯
```

---

## ğŸ”¸ ç¸½çµ

é€™å€‹ PR çš„è¨­è¨ˆæ ¸å¿ƒï¼š

| å•é¡Œ | è§£æ³• |
|-----|------|
| Proto å’Œ DataFusion é¡å‹ä¸å°æ‡‰ | å¼•å…¥ Spec Layer ä½œç‚ºä¸­é–“å±¤ |
| è§£æé †åºå•é¡Œï¼ˆå¼•ç”¨å…ˆæ–¼å®šç¾©ï¼‰ | å…ˆè§£æ referencesï¼Œå­˜å…¥ HashMap |
| DataFusion API éœ€è¦å®Œæ•´çš„ LogicalPlan | å‰µå»º Placeholder ç¯€é» |
| ç¢ºä¿ Placeholder è¢«æ›¿æ› | ä¸è¨»å†Š ExtensionPlannerï¼ˆé˜²ç¦¦æ€§è¨­è¨ˆï¼‰ |
| æ›¿æ›å¾Œ schema æ”¹è®Š | ä½¿ç”¨ transform_upï¼Œä¸¦ç‰¹æ®Šè™•ç† Projection |

é€™ç¨®ã€ŒPlaceholder + Deferred Resolutionã€æ¨¡å¼åœ¨ç·¨è­¯å™¨å’ŒæŸ¥è©¢å„ªåŒ–å™¨ä¸­å¾ˆå¸¸è¦‹ï¼Œæ˜¯è™•ç†ã€Œå‰å‘å¼•ç”¨ã€å•é¡Œçš„æ¨™æº–è§£æ³•ã€‚
